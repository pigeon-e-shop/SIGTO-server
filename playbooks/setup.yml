---
- name: Setup servidor Pigeon e-Shop
  hosts: servidores
  become: yes 
  tasks:
    - name: Actualizar la lista de paquetes
      apt:
        update_cache: yes

    - name: Instalar Apache
      apt:
        name: apache2
        state: present
      notify:
        - Habilitar y arrancar Apache

    - name: Instalar PHP y módulos
      apt:
        name:
          - php
          - libapache2-mod-php
          - php-mysql
        state: present
      notify:
        - Habilitar y arrancar Apache

    - name: Instalar nano
      apt:
        name: nano
        state: present

    - name: Configurar nano como editor por defecto
      lineinfile:
        path: /etc/environment
        line: 'EDITOR=nano'
        create: yes

    - name: Instalar utilidades adicionales
      apt:
        name:
          - curl
          - git
          - openssh-server
          - net-tools
          - ufw
          - mariadb-server
          - mariadb-client
          - python3-mysqldb  # Cambiado a mysqldb para compatibilidad con MariaDB
        state: present
      register: utils_install
      changed_when: utils_install.changed

    - name: Mensaje de instalación de utilidades
      debug:
        msg: "Las utilidades adicionales se han instalado correctamente."
      when: utils_install.changed

    - name: Clonar el repositorio pigeon-e-shop/SIGTO
      git:
        repo: 'https://github.com/pigeon-e-shop/SIGTO.git'
        dest: /var/www/html/SIGTO
        update: yes

    - name: Importar base de datos desde el archivo SQL
      mysql_db:
        name: 'pigeon'
        state: import
        target: /var/www/html/SIGTO/Config/Database.sql
        login_user: 'root'
        login_password: ''  # Cambia esto si tienes una contraseña establecida

  handlers:
    - name: Habilitar y arrancar Apache
      systemd:
        name: apache2
        enabled: yes
        state: started

    - name: Habilitar y arrancar MySQL
      systemd:
        name: mariadb
        enabled: yes
        state: started
